<div class="page-container">

  <h1 class="page-title">Моите паркинги</h1>

  <!-- LIST SECTION -->
  <section class="section">
    <h2 class="section-title">Списък</h2>

    <div *ngIf="parkings.length === 0" class="empty-state">
      Нямате създадени паркинги.
    </div>

    <div class="cards">
      <div class="parking-card" *ngFor="let p of parkings">
        <h3>{{ p.name }}</h3>
        <p class="address">{{ p.address }}</p>
        <div class="map-image-wrapper" *ngIf="p.mapImageUrl">
          <img [src]="p.mapImageUrl"
               alt="Карта на паркинга"
               class="map-image"
               (error)="p.mapImageUrl = ''">
        </div>

        <div class="details">
          <span>Места: <strong>{{ p.spacesCount }}</strong></span>
          <span>Цена за час: <strong>{{ p.pricePerHourBgn }} лв.
      / {{ priceInEur(p.pricePerHourBgn) | number:'1.2-2' }} €</strong></span>
          <span>Плащане с карта: <strong>{{ p.cardPaymentEnabled ? 'Да' : 'Не' }}</strong></span>
          <span>Бонус програма: <strong>{{ p.loyaltyEnabled ? 'Да' : 'Не' }}</strong></span>

          <ng-container *ngIf="p.loyaltyEnabled">
    <span>
      Необходими посещения за 1 точка:
      <strong>{{ p.loyaltyVisitPerPoint || '-' }}</strong>
    </span>
            <span>
      Необходими точки за бонус:
      <strong>{{ p.loyaltyPointsRequired || '-' }}</strong>
    </span>
            <span>
      Бонус:
      <strong>
        {{
          p.loyaltyRewardHours === 'ONE_HOUR' ? '1 час' :
            p.loyaltyRewardHours === 'THREE_HOURS' ? '3 часа' :
              p.loyaltyRewardHours === 'SIX_HOURS' ? '6 часа' :
                p.loyaltyRewardHours === 'EIGHT_HOURS' ? '8 часа' : '-'
        }}
      </strong>
    </span>
          </ng-container>
        </div>

        <div class="actions">
          <button class="btn edit-btn" (click)="startEdit(p)">Редактирай</button>
          <button class="btn delete-btn" (click)="deleteParking(p.id)">Изтрий</button>
        </div>
      </div>
    </div>
  </section>

  <!-- CREATE SECTION -->
  <section class="section">
    <h2 class="section-title">Нов паркинг</h2>

    <form id="parking-form" [formGroup]="parkingForm" (ngSubmit)="saveParking()" class="form-card">

      <div class="form-grid">
        <div class="form-field">
          <label class="required">Име</label>
          <input formControlName="name" type="text"/>
        </div>

        <div class="form-field">
          <label class="required">Град</label>
          <input formControlName="city" type="text"/>
        </div>

        <div class="form-field">
          <label class="required">Адрес (улица)</label>
          <input formControlName="address" type="text"/>
        </div>

        <div class="form-field">
          <label class="required">Телефон за контакт</label>
          <input formControlName="contactPhone" type="tel" placeholder="+359 88 123 4567"/>
        </div>

        <div class="form-field">
          <label class="required">Брой паркоместа</label>
          <input formControlName="spacesCount" type="number" min="0"/>
        </div>

        <div class="form-field">
          <label class="required">Цена на час (лв)</label>
          <input formControlName="pricePerHourBgn" type="number" step="1.00" min="0"/>
        </div>

        <div class="form-field checkbox-field">
          <label>Плащане с карта</label>
          <input formControlName="cardPaymentEnabled" type="checkbox"/>
        </div>

        <div class="working-hours">
          <div class="form-field checkbox-field">
            <label>Денонощно</label>
            <input formControlName="open24Hours" type="checkbox"/>
          </div>

          <div class="form-field" *ngIf="!parkingForm.get('open24Hours')?.value">
            <label class="required">Отваря в</label>
            <input formControlName="openingTime" type="time"/>
          </div>

          <div class="form-field" *ngIf="!parkingForm.get('open24Hours')?.value">
            <label class="required">Затваря в</label>
            <input formControlName="closingTime" type="time"/>
          </div>
          <div *ngIf="parkingForm.hasError('workingHoursMissing')" class="error-message">
            Моля, изберете „Денонощно“ или въведете час на отваряне и затваряне.
          </div>
          <div *ngIf="parkingForm.hasError('workingHoursInvalid')" class="error-message">
            Работното време е невалидно: часът на отваряне трябва да бъде преди часа на затваряне.
          </div>
        </div>

        <div class="form-field checkbox-field">
          <label>Бонус програма</label>
          <input formControlName="loyaltyEnabled" type="checkbox"/>
        </div>

        <div class="form-field">
          <label>URL към карта/снимка (по желание)</label>
          <input formControlName="mapImageUrl" type="text"/>
        </div>
      </div>

      <div class="bonus-section" *ngIf="parkingForm.get('loyaltyEnabled')?.value">
        <div class="form-field">
          <label class="required">Необходими посещения за 1 бонус точка</label>
          <input formControlName="loyaltyVisitPerPoint" type="number" min="1"/>
        </div>

        <div class="form-field">
          <label class="required">Необходими точки за награда</label>
          <input formControlName="loyaltyPointsRequired" type="number" min="1"/>
        </div>

        <div class="form-field">
          <label class="required">Бонус (безплатни часове)</label>
          <select formControlName="loyaltyRewardHours">
            <option [ngValue]="null">-- избери --</option>
            <option value="ONE_HOUR">1 час</option>
            <option value="THREE_HOURS">3 часа</option>
            <option value="SIX_HOURS">6 часа</option>
            <option value="EIGHT_HOURS">8 часа</option>
          </select>
        </div>
      </div>

      <button
        type="submit"
        class="btn save-btn"
        [disabled]="parkingForm.invalid">
        Запази
      </button>

      <button *ngIf="editing" type="button" class="btn cancel-btn" (click)="cancelEdit()">
        Отказ
      </button>

    </form>


  </section>

</div>
